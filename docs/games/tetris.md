# テトリス（Tetris）

## ゲーム概要

世界的に有名なパズルゲーム「テトリス」の実装です。落下してくるテトロミノ（7種類のブロック）を操作して、横一列を揃えて消していきます。標準的なテトリスルール（SRS回転システム、7-bagランダマイザー）に加え、T-spinやコンボなどの高度なテクニックにも対応しています。

## 主要機能

### 基本ゲームプレイ
- 7種類のテトロミノ（I, O, T, S, Z, J, L）
- 横一列を揃えるとライン消去
- ライン消去に応じてレベルアップ（落下速度上昇）
- ゲームオーバー条件：新しいブロックが配置できなくなった時

### SRS（Super Rotation System）回転システム
- **I-piece**: 4×4グリッド
- **その他**: 3×3グリッド
- 標準的な回転アルゴリズムを採用
- 回転時の壁蹴り判定

### 7-bag ランダムジェネレーター
- テトリス標準のランダム生成システム
- 7種類のピースを1セット（bag）としてシャッフル
- すべてのピースが1回ずつ出現してから次のセット
- Fisher-Yates シャッフルアルゴリズム採用
- 偏りのない公平な配置

### HOLD機能
- 現在のピースを保留して後で使用可能
- 保留できるピースは1個まで
- 戦略的なピース管理が可能

### NEXT表示
- **6手先まで**のピースを表示
- 先読みして戦略を立てられる
- 視覚的に分かりやすい配置

### ゴーストピース
- 現在の位置から落下した時の着地位置を半透明で表示
- ハードドロップ先の確認が容易
- プレイの精度向上をサポート

### 高度なスコアシステム

#### 基本スコア
| アクション | スコア | 説明 |
|----------|--------|------|
| 1ライン消去 | 100点 × レベル | シングル |
| 2ライン消去 | 300点 × レベル | ダブル |
| 3ライン消去 | 500点 × レベル | トリプル |
| 4ライン消去 | 800点 × レベル | テトリス |

#### T-spinシステム
- **T-spin検出**: T-pieceを回転して配置した時、3つ以上の角がブロックで囲まれている場合
- **T-spin シングル**: 800点 × レベル（1ライン消去）
- **T-spin ダブル**: 1200点 × レベル（2ライン消去）
- **T-spin トリプル**: 1600点 × レベル（3ライン消去）
- 3-corner check アルゴリズムで判定

#### REN（コンボ）システム
- 連続してラインを消すとコンボボーナス
- **コンボボーナス**: 50点 × コンボ数 × レベル
- ラインが消せなかった場合、コンボはリセット
- 最大コンボ数を記録

#### Back to Back（B2B）システム
- テトリス（4ライン）またはT-spinを連続で決めた時
- **B2Bボーナス**: 基本スコアの1.5倍
- 難易度の高い技を連続で成功させる必要がある
- B2B回数を統計として記録

### スコア統計表示
ゲームオーバー時に以下の詳細統計を表示：
- 1/2/3ライン消去回数
- テトリス（4ライン）回数
- T-spin シングル/ダブル/トリプル回数
- 最大コンボ数
- Back to Back 回数

### ハイスコア機能
- スコア、レベル、ライン数を記録（localStorage）
- ゲーム画面に常時表示
- 自己ベスト更新のモチベーション維持

### レスポンシブ対応
- スマホ・PC両対応
- タッチ操作最適化
- レイアウト自動調整

## UI/UX仕様

### 3列レイアウト
- **左列**: HOLD、スコア、レベル、ライン、コンボ、ハイスコア
- **中央**: ゲーム盤面（10×20グリッド）
- **右列**: NEXT表示（6手先）、操作ボタン

### カラースキーム
各テトロミノに専用色を設定：
- **I-piece**: シアン（#00f0f0）
- **O-piece**: イエロー（#f0f000）
- **T-piece**: パープル（#a000f0）
- **S-piece**: グリーン（#00f000）
- **Z-piece**: レッド（#f00000）
- **J-piece**: ブルー（#0000f0）
- **L-piece**: オレンジ（#f0a000）

### 操作説明モーダル
- 操作方法とスコアシステムを統合表示
- 基本スコア表
- ボーナスシステム説明（コンボ・B2B）
- いつでもアクセス可能

## 技術仕様

### アーキテクチャ
```
tetris/
├── src/
│   ├── game.js          # ゲームロジック・スコアシステム
│   ├── tetromino.js     # テトロミノ定義・回転処理
│   ├── main.js          # UI制御・ゲームループ
│   ├── index.html       # HTML構造
│   └── style.css        # スタイル定義
└── tests/
    └── game.test.js     # ユニットテスト（33テスト）
```

### コアクラス

#### Gameクラス
主要メソッド：
- `spawnPiece()`: 新しいピースを生成
- `rotate()`: ピース回転・壁蹴り判定
- `moveDown()` / `moveLeft()` / `moveRight()`: 移動処理
- `hardDrop()`: 即座に落下
- `hold()`: ピース保留
- `clearLines()`: ライン消去・スコア計算
- `detectTSpin()`: T-spin判定（3-corner check）
- `generateBag()`: 7-bag生成
- `checkCollision()`: 衝突判定

#### Tetrominoクラス
- 7種類のテトロミノ定義
- 回転状態管理（0-3）
- シェイプ配列とカラー情報

### テスト戦略
- **Vitest**によるユニットテスト
- **33テストケース**で全機能をカバー
- 正常系・境界値・異常系・エッジケースを網羅
- CI/CDパイプラインで自動実行

### データ永続化
- **localStorage**でハイスコア保存
- スコア、レベル、ライン数を記録
- ブラウザ再起動後も保持

## 操作方法

### キーボード操作
| キー | 動作 |
|-----|------|
| ←→ | 左右移動 |
| ↓ | 高速落下 |
| ↑ / スペース | 回転 |
| C | ホールド |
| エンター | ハードドロップ |

### マウス/タッチ操作
- **リセットボタン**: ゲーム再開
- **操作方法ボタン**: 操作説明表示

## ゲーム戦略

### 基本戦略
1. **平らに積む**: 凹凸を少なくして安定させる
2. **I-pieceを温存**: テトリスを狙うためHOLD活用
3. **T-spinの基本形を覚える**: 高得点獲得のカギ

### 高度なテクニック
1. **T-spin Triple**: 3ライン同時消去の最高難度技
2. **Back to Back継続**: テトリスとT-spinを交互に決める
3. **コンボ維持**: 途切れさせずにライン消去を続ける
4. **6手先読み**: NEXT表示を活用して最適配置を計画

### スコアアップのコツ
- レベルが上がるほど得点効率が良い
- コンボは序盤から狙う（50点×コンボ×レベル）
- B2Bは維持すると基本スコアの1.5倍
- T-spinは通常の4ライン消去より高得点

## 今後の拡張予定
- [ ] オンラインランキング機能
- [ ] リプレイ機能
- [ ] マルチプレイヤー対戦
- [ ] カスタムテーマ
- [ ] サウンドエフェクト・BGM

## プレイリンク
[テトリスをプレイ](https://tktaka20.github.io/web-games/tetris/src/){ .md-button .md-button--primary }

## ソースコード
[GitHubで見る](https://github.com/tktaka20/web-games/tree/main/tetris){ .md-button }
